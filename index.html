
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TransLogix | Professional POD</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .gradient-brand { background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%); }
        .input-field { width: 100%; padding: 14px; border: 2px solid #e2e8f0; border-radius: 12px; outline: none; font-size: 16px; transition: all 0.2s; }
        .input-field:focus { border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
        
        #previewModal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 500; flex-direction: column; align-items: center; justify-content: center; padding: 20px; }
        #enlargedImg { max-width: 100%; max-height: 80vh; border-radius: 12px; border: 2px solid white; }
        
        #gpsModal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 200; align-items: center; justify-content: center; padding: 20px; }
        #loaderOverlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 100; flex-direction: column; align-items: center; justify-content: center; color: white; }
        .btn-disabled { background: #94a3b8 !important; opacity: 0.6; cursor: not-allowed; }
        
        .signal-dot { height: 10px; width: 10px; border-radius: 50%; display: inline-block; margin-right: 6px; }
        .sig-green { background-color: #22c55e; box-shadow: 0 0 8px #22c55e; }
        .sig-yellow { background-color: #eab308; box-shadow: 0 0 8px #eab308; }
        .sig-red { background-color: #ef4444; box-shadow: 0 0 8px #ef4444; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">

    <div id="previewModal" onclick="this.style.display='none'">
        <img id="enlargedImg" src="">
        <p class="text-white mt-6 font-bold uppercase tracking-widest text-sm bg-white/10 px-4 py-2 rounded-full">Tap to close</p>
    </div>

    <div id="gpsModal">
        <div class="bg-white p-8 rounded-3xl w-full max-w-sm text-center shadow-2xl">
            <div class="text-5xl mb-4">üìç</div>
            <h2 class="text-xl font-bold mb-2">GPS Required</h2>
            <p class="text-gray-500 text-sm mb-6">Location access is mandatory. Please enable GPS and refresh.</p>
            <button onclick="location.reload()" class="w-full bg-blue-600 text-white font-bold py-4 rounded-xl shadow-lg">REFRESH</button>
        </div>
    </div>

    <div id="loaderOverlay">
        <div class="animate-spin rounded-full h-14 w-14 border-t-4 border-blue-500 mb-4"></div>
        <p class="text-lg font-bold uppercase tracking-widest text-center px-4">Stamping Geotag & Uploading...</p>
    </div>

    <nav class="gradient-brand p-5 shadow-lg text-white flex justify-between items-center sticky top-0 z-50">
        <div class="flex flex-col">
            <span class="font-black uppercase tracking-tighter text-xl italic leading-none">TransLogix</span>
            <span class="text-[9px] font-bold tracking-[0.2em] opacity-80 uppercase">Proof of Delivery</span>
        </div>
        <div class="bg-black/20 px-4 py-2 rounded-2xl flex items-center backdrop-blur-md">
            <span id="sigDot" class="signal-dot sig-red"></span>
            <span id="sigText" class="text-[10px] font-black uppercase">GPS: OFF</span>
        </div>
    </nav>

    <div class="container mx-auto p-4 max-w-xl pb-12">
        <form id="podForm" class="bg-white p-6 rounded-[2.5rem] shadow-2xl space-y-6">
            
            <div class="space-y-4">
                <h3 class="text-[11px] font-black text-blue-600 uppercase tracking-widest border-b pb-2">1. Driver Identity</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <input type="text" id="driverName" placeholder="Driver Name" required class="input-field uppercase">
                    <input type="tel" id="driverPhone" placeholder="Driver Phone" required class="input-field">
                </div>
            </div>

            <div class="space-y-4 pt-2">
                <h3 class="text-[11px] font-black text-blue-600 uppercase tracking-widest border-b pb-2">2. Trip Details</h3>
                <div class="grid grid-cols-2 gap-4">
                    <input type="text" id="vehicleNo" placeholder="Vehicle No" required class="input-field uppercase no-space">
                    <input type="text" id="podNo" placeholder="POD No" required class="input-field uppercase no-space">
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="text-[9px] font-black text-gray-400 uppercase ml-1">Date</label>
                        <input type="date" id="deliveryDate" required class="input-field">
                    </div>
                    <div>
                        <label class="text-[9px] font-black text-gray-400 uppercase ml-1">Time</label>
                        <input type="time" id="deliveryTime" required class="input-field">
                    </div>
                    <div>
                        <label class="text-[9px] font-black text-gray-400 uppercase ml-1">Client</label>
                        <select id="companyName" required class="input-field bg-white">
                            <option value="">Select</option>
                            <option value="Amazon">Amazon</option>
                            <option value="Tata Steel">Tata Steel</option>
                            <option value="Reliance">Reliance</option>
                        </select>
                    </div>
                </div>
            </div>

            <div id="uploadArea">
                <div id="uploadBox" class="border-2 border-dashed border-blue-100 p-8 rounded-3xl bg-blue-50/50">
                    <div class="grid grid-cols-2 gap-6">
                        <button type="button" onclick="document.getElementById('cameraIn').click()" class="flex flex-col items-center justify-center bg-blue-600 text-white p-6 rounded-2xl shadow-xl active:scale-95 transition-all">
                            <span class="text-4xl">üì∑</span>
                            <span class="text-[10px] font-black mt-3 uppercase tracking-widest">Camera</span>
                        </button>
                        <button type="button" onclick="document.getElementById('galleryIn').click()" class="flex flex-col items-center justify-center bg-white border-2 border-blue-600 text-blue-600 p-6 rounded-2xl shadow-xl active:scale-95 transition-all">
                            <span class="text-4xl">üñºÔ∏è</span>
                            <span class="text-[10px] font-black mt-3 uppercase tracking-widest">Gallery</span>
                        </button>
                    </div>
                </div>

                <div id="imagePreviewArea" class="hidden p-5 border-2 border-green-200 rounded-3xl bg-green-50 flex items-center justify-between shadow-inner">
                    <div class="flex items-center space-x-4 cursor-pointer" onclick="showEnlarged()">
                        <img id="thumbnail" class="h-20 w-16 object-cover rounded-lg shadow-md border-2 border-white">
                        <div>
                            <p class="text-xs font-black text-green-800 uppercase leading-none">POD Loaded</p>
                            <p class="text-[10px] text-blue-600 underline font-bold uppercase mt-1">Tap to verify</p>
                        </div>
                    </div>
                    <button type="button" onclick="document.getElementById('cameraIn').click()" class="bg-blue-600 text-white px-5 py-3 rounded-2xl font-black text-[10px] uppercase shadow-lg active:scale-90 transition-all">Retake</button>
                </div>
            </div>

            <input type="file" id="cameraIn" accept="image/*" capture="environment" class="hidden">
            <input type="file" id="galleryIn" accept="image/*" class="hidden">

            <button type="submit" id="submitBtn" class="btn-disabled w-full gradient-brand text-white font-black py-6 rounded-2xl shadow-2xl uppercase tracking-[0.2em] text-lg active:scale-[0.98] transition-all" disabled>
                Waiting for GPS...
            </button>
        </form>
    </div>

    <canvas id="canvas" class="hidden"></canvas>

    <script>
        const sigDot = document.getElementById('sigDot');
        const sigText = document.getElementById('sigText');
        const submitBtn = document.getElementById('submitBtn');
        const modal = document.getElementById('gpsModal');
        const previewModal = document.getElementById('previewModal');
        const enlargedImg = document.getElementById('enlargedImg');
        let userLoc = null;
        let selectedFile = null;

        // Auto-fill Current Date and Time
        window.onload = () => {
            const now = new Date();
            document.getElementById('deliveryDate').value = now.toISOString().split('T')[0];
            document.getElementById('deliveryTime').value = now.toTimeString().slice(0,5);
            startGPS();
        };

        document.querySelectorAll('.no-space').forEach(input => {
            input.addEventListener('blur', function() {
                this.value = this.value.replace(/\s+/g, '').toUpperCase();
            });
        });

        function startGPS() {
            if (navigator.geolocation) {
                navigator.geolocation.watchPosition(
                    (p) => {
                        const acc = p.coords.accuracy;
                        userLoc = `GPS: ${p.coords.latitude.toFixed(6)}, ${p.coords.longitude.toFixed(6)} (¬±${Math.round(acc)}m)`;
                        modal.style.display = 'none';
                        if (acc <= 50) { sigDot.className = "signal-dot sig-green"; sigText.innerText = "GPS: STRONG"; }
                        else if (acc <= 150) { sigDot.className = "signal-dot sig-yellow"; sigText.innerText = "GPS: WEAK"; }
                        else { sigDot.className = "signal-dot sig-red"; sigText.innerText = "GPS: POOR"; }
                        submitBtn.disabled = false;
                        submitBtn.classList.remove('btn-disabled');
                        submitBtn.innerText = "SUBMIT VERIFIED POD";
                    },
                    (err) => { modal.style.display = 'flex'; },
                    { enableHighAccuracy: true }
                );
            }
        }

        [document.getElementById('cameraIn'), document.getElementById('galleryIn')].forEach(input => {
            input.onchange = (e) => {
                if(e.target.files[0]) {
                    selectedFile = e.target.files[0];
                    const reader = new FileReader();
                    reader.onload = (re) => {
                        document.getElementById('thumbnail').src = re.target.result;
                        enlargedImg.src = re.target.result;
                        document.getElementById('uploadBox').classList.add('hidden');
                        document.getElementById('imagePreviewArea').classList.remove('hidden');
                    };
                    reader.readAsDataURL(selectedFile);
                }
            };
        });

        function showEnlarged() { previewModal.style.display = 'flex'; }

        document.getElementById('podForm').onsubmit = async (e) => {
            e.preventDefault();
            if(!selectedFile) return alert("Please capture photo!");
            
            document.getElementById('loaderOverlay').style.display = 'flex';
            const img = new Image();
            img.src = document.getElementById('thumbnail').src;
            img.onload = async () => {
                const canvas = document.getElementById('canvas');
                canvas.width = img.width; canvas.height = img.height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0);
                
                const barH = canvas.height * 0.12;
                ctx.fillStyle = "rgba(0,0,0,0.75)";
                ctx.fillRect(0, canvas.height - barH, canvas.width, barH);
                ctx.fillStyle = "white"; 
                ctx.font = `bold ${canvas.width/30}px Arial`;
                ctx.fillText(`TRANSLOGIX | DRIVER: ${document.getElementById('driverName').value.toUpperCase()}`, 50, canvas.height - (barH*0.7));
                ctx.font = `${canvas.width/40}px Arial`;
                ctx.fillText(`TRIP: ${document.getElementById('vehicleNo').value} | POD: ${document.getElementById('podNo').value}`, 50, canvas.height - (barH*0.45));
                ctx.fillText(`TIME: ${document.getElementById('deliveryDate').value} ${document.getElementById('deliveryTime').value} | ${userLoc}`, 50, canvas.height - (barH*0.2));

                const finalData = canvas.toDataURL('image/jpeg', 0.8).split(',')[1];
                
                const payload = new URLSearchParams({
                    driverName: document.getElementById('driverName').value,
                    driverPhone: document.getElementById('driverPhone').value,
                    vehicleNo: document.getElementById('vehicleNo').value,
                    podNo: document.getElementById('podNo').value,
                    deliveryDate: document.getElementById('deliveryDate').value,
                    deliveryTime: document.getElementById('deliveryTime').value,
                    companyName: document.getElementById('companyName').value,
                    fileBase64: finalData
                });

                // In Production: 
                // await fetch('YOUR_APPS_SCRIPT_URL_HERE', { method: 'POST', body: payload });
                alert("‚úÖ POD RECORDED WITH GEOTAG & TIME!");
                location.reload(); 
            };
        };
    </script>
</body>
</html>
